---
phase: 04-semantic-intelligence
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - commands/gsd/analyze-codebase.md
  - package.json
autonomous: true

must_haves:
  truths:
    - "Claude creates entity files with semantic understanding via /gsd:analyze-codebase"
    - "Entity files include purpose, not just syntax"
    - "Batch processing handles 100+ files efficiently"
  artifacts:
    - path: "commands/gsd/analyze-codebase.md"
      provides: "Semantic entity generation via Claude API"
      contains: "@anthropic-ai/sdk"
    - path: "package.json"
      provides: "Anthropic SDK dependency"
      contains: "@anthropic-ai/sdk"
  key_links:
    - from: "commands/gsd/analyze-codebase.md"
      to: "Anthropic Messages API"
      via: "client.messages.create"
      pattern: "messages\\.create"
---

<objective>
Enhance /gsd:analyze-codebase to create semantic entity files using Claude API.

Purpose: Generate entity documentation that captures file PURPOSE (what it does, why it exists), not just syntax (exports/imports). This transforms "2-3 ls commands" of information into genuine semantic understanding.

Output: Updated analyze-codebase.md command with Claude API integration, @anthropic-ai/sdk dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-semantic-intelligence/04-RESEARCH.md
@.planning/phases/04-semantic-intelligence/04-01-SUMMARY.md

From research:
- Use @anthropic-ai/sdk for Claude API calls
- claude-sonnet-4-5-20250929 for entity generation (fast, cost-effective)
- Process files in batches to avoid rate limits
- Entity template format already exists

Current analyze-codebase.md:
- Steps 1-8 for bulk codebase scanning
- Creates index.json, conventions.json, summary.md
- Does NOT create entity files

New requirement:
- After indexing, optionally create entity .md files
- Use Claude to write semantic purpose, not just regex extraction
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Anthropic SDK dependency</name>
  <files>package.json</files>
  <action>
Add @anthropic-ai/sdk to package.json dependencies:

```json
"dependencies": {
  "sql.js": "^1.12.0",
  "@anthropic-ai/sdk": "^0.52.0"
}
```

Note: Version 0.52.0+ includes Messages API with proper TypeScript support.
  </action>
  <verify>`grep -q "@anthropic-ai/sdk" package.json`</verify>
  <done>@anthropic-ai/sdk added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Add semantic entity generation to analyze-codebase</name>
  <files>commands/gsd/analyze-codebase.md</files>
  <action>
Update the analyze-codebase.md command to add entity generation after index creation.

1. Update the objective to mention entity generation:
```markdown
<objective>
Scan codebase to populate .planning/intel/ with file index, conventions, and semantic entity documentation.

Works standalone (without /gsd:new-project) for brownfield codebases. Creates:
- index.json for file index
- conventions.json for naming patterns
- summary.md for context injection
- entities/*.md for semantic file documentation (optional, requires ANTHROPIC_API_KEY)

Output: .planning/intel/index.json, conventions.json, summary.md, entities/*.md
</objective>
```

2. Add allowed-tools: Task (for entity generation subagent)

3. Add new Step 9 after Step 8 (before completion report):

```markdown
## Step 9: Generate semantic entities (optional)

If `ANTHROPIC_API_KEY` environment variable is set, generate semantic entity files.

### 9a: Select key files for entity generation

From the index, select files for entity generation using these criteria:
- Files with 3+ exports (significant modules)
- Files imported by 5+ other files (dependency hotspots)
- Files in key directories: api/, lib/, utils/, services/, models/
- Limit to 50 files maximum per run (avoid excessive API costs)

Skip:
- Test files (*.test.*, *.spec.*)
- Generated files (*.generated.*, *.d.ts)
- Config files (*.config.*)
- Files already with entities in .planning/intel/entities/

### 9b: Create entity directory

```bash
mkdir -p .planning/intel/entities
```

### 9c: Generate entities using Claude API

For each selected file, use the Anthropic SDK to generate entity content:

```javascript
const Anthropic = require('@anthropic-ai/sdk');
const client = new Anthropic(); // Uses ANTHROPIC_API_KEY env var

async function generateEntityContent(filePath, fileContent) {
  const response = await client.messages.create({
    model: 'claude-sonnet-4-5-20250929',
    max_tokens: 1500,
    system: `You are a senior engineer documenting a codebase. Create entity documentation following this exact template format. Be concise - focus on PURPOSE and key relationships.

Output ONLY the markdown content, no explanations or commentary.`,
    messages: [{
      role: 'user',
      content: `Create entity documentation for this file.

Path: ${filePath}
Content:
\`\`\`
${fileContent}
\`\`\`

Follow this template EXACTLY:

---
path: ${filePath}
type: [module|component|util|config|test|api|hook|service|model]
updated: ${new Date().toISOString().split('T')[0]}
status: active
---

# [filename]

## Purpose

[1-3 sentences: What does this file do? Why does it exist? What problem does it solve?]

## Exports

[List each export with signature and brief description]
- \`exportName(args): ReturnType\` - What it does

## Dependencies

[Internal deps use wiki-links, external use plain text]
- [[slugified-path]] - Why needed
- external-package - Why needed

## Used By

TBD

## Notes

[Optional: patterns, gotchas, or important context]`
    }]
  });

  return response.content[0].text;
}
```

### 9d: Write entity files

For each generated entity:
1. Create slug from path: `src/lib/db.ts` -> `src-lib-db`
2. Write to `.planning/intel/entities/{slug}.md`
3. The PostToolUse hook will automatically sync to graph.db

### 9e: Process in batches

Process files in batches of 5 with 1 second delay between batches to respect rate limits.

```javascript
async function processEntities(files) {
  const batchSize = 5;
  for (let i = 0; i < files.length; i += batchSize) {
    const batch = files.slice(i, i + batchSize);
    await Promise.all(batch.map(async (filePath) => {
      const content = fs.readFileSync(filePath, 'utf8');
      const entityContent = await generateEntityContent(filePath, content);
      const slug = filePath.replace(/^\//, '').replace(/[\/\.]/g, '-').replace(/-[jt]sx?$/, '');
      fs.writeFileSync(`.planning/intel/entities/${slug}.md`, entityContent);
    }));
    if (i + batchSize < files.length) {
      await new Promise(r => setTimeout(r, 1000)); // Rate limit
    }
  }
}
```
```

4. Update Step 10 (completion report) to include entity stats:

```markdown
## Step 10: Report completion

Display summary statistics:

\`\`\`
Codebase Analysis Complete

Files indexed: [N]
Exports found: [N]
Imports found: [N]

Conventions detected:
- Naming: [dominant case] ([percentage]%)
- Directories: [list]
- Patterns: [list]

Entities created: [N] (if ANTHROPIC_API_KEY set)
- Skipped: [N] (already existed or filtered)

Files created:
- .planning/intel/index.json
- .planning/intel/conventions.json
- .planning/intel/summary.md
- .planning/intel/entities/*.md (if API key set)

Next: Intel hooks will continue incremental learning as you code.
\`\`\`
```

5. Update success criteria to include entity generation:

```markdown
<success_criteria>
- [ ] .planning/intel/ directory created
- [ ] All JS/TS files scanned (excluding node_modules, dist, build, .git, vendor, coverage)
- [ ] index.json populated with exports and imports for each file
- [ ] conventions.json has detected patterns (naming, directories, suffixes)
- [ ] summary.md is concise (< 500 tokens)
- [ ] entities/*.md created for key files (if ANTHROPIC_API_KEY set)
- [ ] Statistics reported to user
</success_criteria>
```
  </action>
  <verify>
```bash
# Check command has entity generation step
grep -q "Generate semantic entities" commands/gsd/analyze-codebase.md && echo "PASS: Step 9 exists"

# Check mentions Anthropic SDK
grep -q "@anthropic-ai/sdk" commands/gsd/analyze-codebase.md && echo "PASS: SDK mentioned"

# Check has batch processing
grep -q "batchSize" commands/gsd/analyze-codebase.md && echo "PASS: Batch processing"
```
  </verify>
  <done>analyze-codebase.md includes semantic entity generation via Claude API</done>
</task>

<task type="auto">
  <name>Task 3: Add fallback messaging for missing API key</name>
  <files>commands/gsd/analyze-codebase.md</files>
  <action>
Add clear messaging when ANTHROPIC_API_KEY is not set.

In the context section, add:

```markdown
**Entity generation (optional):**
Requires `ANTHROPIC_API_KEY` environment variable. If not set, only index/conventions/summary are created. Set with:
```bash
export ANTHROPIC_API_KEY=sk-ant-...
```

Entity generation costs approximately $0.01-0.02 per file (using claude-sonnet-4-5-20250929).
```

In Step 9, add at the beginning:

```markdown
## Step 9: Generate semantic entities (optional)

**Check for API key:**
```javascript
if (!process.env.ANTHROPIC_API_KEY) {
  console.log('Skipping entity generation: ANTHROPIC_API_KEY not set');
  console.log('To enable, run: export ANTHROPIC_API_KEY=sk-ant-...');
  // Skip to Step 10
}
```

If no API key, skip directly to Step 10 with message:
```
Entity generation skipped (no ANTHROPIC_API_KEY).
To enable semantic entities, set ANTHROPIC_API_KEY and re-run.
```
```

This ensures the command still works without API key (backwards compatible) while clearly explaining how to enable entity generation.
  </action>
  <verify>
```bash
grep -q "ANTHROPIC_API_KEY not set" commands/gsd/analyze-codebase.md && echo "PASS: Fallback messaging exists"
```
  </verify>
  <done>Command gracefully handles missing API key with clear instructions</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. SDK dependency added:
   ```bash
   grep -q "@anthropic-ai/sdk" package.json && echo "PASS"
   ```

2. Command has entity generation:
   ```bash
   grep -q "Step 9" commands/gsd/analyze-codebase.md && echo "PASS"
   grep -q "generateEntityContent" commands/gsd/analyze-codebase.md && echo "PASS"
   ```

3. Fallback works:
   ```bash
   grep -q "ANTHROPIC_API_KEY not set" commands/gsd/analyze-codebase.md && echo "PASS"
   ```

4. Batch processing:
   ```bash
   grep -q "batchSize" commands/gsd/analyze-codebase.md && echo "PASS"
   ```

Manual test (requires API key):
```bash
export ANTHROPIC_API_KEY=sk-ant-...
# Run /gsd:analyze-codebase on a test project
# Verify .planning/intel/entities/*.md created with semantic content
```
</verification>

<success_criteria>
- [ ] @anthropic-ai/sdk added to package.json
- [ ] Step 9 added for entity generation
- [ ] File selection criteria documented (3+ exports, 5+ dependents, key dirs)
- [ ] 50 file limit per run to control costs
- [ ] Batch processing with rate limiting (5 files, 1s delay)
- [ ] Entity slug convention documented
- [ ] Graceful fallback when ANTHROPIC_API_KEY not set
- [ ] Cost estimate included (~$0.01-0.02 per file)
- [ ] Updated success criteria includes entity generation
</success_criteria>

<output>
After completion, create `.planning/phases/04-semantic-intelligence/04-03-SUMMARY.md`
</output>
